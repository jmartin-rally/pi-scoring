<!DOCTYPE html>
<html>
<head>
    <title>PI Scoring App</title>

    <script type="text/javascript" src="/apps/2.0p5/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function() {
            /*global console, Ext */
            Ext.define('CustomApp', {
                extend: 'Rally.app.App',
                componentCls: 'app',
                items: [ 
                    { xtype: 'container', itemId: 'picker_row', defaults: { padding: 5},  layout: { type: 'hbox' }, items: [
            	        { xtype: 'container', itemId: 'type_picker_box' },
            	        { xtype: 'container', itemId: 'column_picker_box' }
                    ]},
                    { xtype: 'container', itemId: 'pi_grid_box', padding: 5 }
                ],
                minimum_columns: [ {text: "ID", dataIndex: "FormattedID"}, {text: "Name", dataIndex: "Name", flex: 1 } ],
                additional_columns: [],
                calculation_fields: [],
                type: null,
                launch: function() {
                    //Write app code here
                    this._addFieldPicker();
                    this._addTypePicker();
                },
                _addFieldPicker: function() {
                    var that = this;
                    var picker = Ext.create('Rally.ui.picker.FieldPicker', {
                        modelType: "PortfolioItem",
                        fieldLabel: "Columns",
                        labelSeparator: "",
                        labelWidth: 45,
                        labelPad: 5,
                        labelCls: "rui-label",
                        stateEvents: ['selectionchange' ],
                        stateful: true,
                        stateId: 'pi-score-columns',
                        fieldWhiteList: ["ActualStartDate", "ActualEndDate", "PlannedStartDate", "PlannedEndDate", "PercentDoneByStoryCount", "PercentDoneByStoryPlanEstimate", "InvestmentCategory","RiskScore", "ValueScore"],
                        listeners: {
                            change: function(picker, newValue, oldValue ) {
                                console.log( "change", picker.getValue, newValue );
                            },
                            selectionchange: function( picker, values, options ) {
                                console.log( "selectionchange", picker.getValue(), values );
                                that._setAdditionalColumns(values);
                                that._getPortfolioItems();
                            }
                        },
                        getState: function() {
                            return { value: this.getValue() };
                        },
                        applyState: function(state) {
                            that._setAdditionalColumns(state.value);
                            this.setValue(state.value);
                        }
                    });  
                    this.down('#column_picker_box').add(picker);
                },
                _setAdditionalColumns: function( values ) {
                    var that = this;
                    that.additional_columns = [];
                    Ext.Array.each( values, function(value) {
                        that.additional_columns.push( {text: value.displayName, dataIndex: value.name});
                    });
                    return true;
                },
                _addTypePicker: function() {
                    var picker = Ext.create('Rally.ui.combobox.PortfolioItemTypeComboBox', {
                        listeners: { 
                           scope: this, 
                           change: function(picker,newValue,oldValue) {
                                this.type = picker.getRecord().getData().TypePath;
                                this._getPortfolioItems();
                           }
                        } 
                    });
                    this.down('#type_picker_box').add(picker);
                },
                _getPortfolioItems: function() {
                	console.log( "_getPortfolioItems" );
                    var that = this;
                	this.pi_store = Ext.create('Rally.data.WsapiDataStore', {
                		autoLoad: true,
                		model: that.type,
                		listeners: {
                			load: function(store,data,success) {
                				this._showGrid();
                			},
                			scope: this
                		},
                		fetch: that._getFetchFields()
                	});
                },
                _getFetchFields: function() {
                    var fields = [];
                    var cols = Ext.Array.merge( this.minimum_columns, this.additional_columns );
                    Ext.Array.each( cols, function( col ) {
                        fields.push( col.name );
                    });
                },
                _showGrid: function() {
                	console.log( "_showGrid");
                	var that = this;
                	if ( this.pi_grid ) { this.pi_grid.destroy(); }
                	this.pi_grid = Ext.create('Rally.ui.grid.Grid', {
                		store: that.pi_store,
                        model: 'PortfolioItem/Feature',
                		columnCfgs:  Ext.Array.merge( that.minimum_columns, that.additional_columns )
                	});
                	this.down('#pi_grid_box').add(this.pi_grid);
            //        var records = this.pi_store.getRecords();
            //        Ext.Array.each( records, function(record) { 
            //            record.set("RiskScore", 6);
            //            record.save();
            //        });
                  
                }
            });

            Rally.launchApp('CustomApp', {
                name: 'PI Scoring App'
            });
        });
    </script>

    <style type="text/css">
        .app {
             /* Add app styles here */
        }
    </style>
</head>
<body></body>
</html>
