<!DOCTYPE html>
<html>
<head>
    <title>PI Scoring App</title>

    <script type="text/javascript" src="/apps/2.0p5/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function() {
            Ext.define( 'PXS.ui.dialog.FormulaDialog', {
            	extend: 'Rally.ui.dialog.Dialog',
            	requires: [ 'Rally.ui.Button' ],
            	closable: false,
            	stateful: false,
            	formula: null,
            	config: {
            		
            	},
            	constructor: function(config) {
            		this.mergeConfig(config);
            		this.callParent(arguments);
            		
            		this.addHeader();
            		this.addEditor();
            		this.addFooter();
            	},
            	initComponent: function() {
            		window.dialog = this;
            		this.callParent(arguments);
            		this.addEvents([
                        /**
                         * @event
                         * Fired before saving the formula.
                         * @param formula the formula being saved.  Return false to prevent saving.
                         */
                         'beforeformulasave'
                    ]);
            	},
            	addHeader: function() {
            		this.add( {
                        xtype: 'component',
                        html: 'To calculate a value for the items in the grid, enter a formula below.<br/><br/>' +
                                'Use the format FieldName = FieldA + FieldB',
                        padding: 10
                    } );
            	},
            	addEditor: function() {
            		this.add({
                            padding: 10,
                            xtype: 'rallytextfield',
                            fieldLabel: 'Formula',
                            width: 250,
                            labelAlign: "top",
            	            labelPad: 5,
            	            labelCls: "rui-label",
                            itemId: 'formula_box'
                    });
            	},
            	addFooter: function() {
            		this.addDocked({
                        xtype: 'toolbar',
                        dock: 'bottom',
                        layout: {
                            pack: 'center'
                        },
                        ui: 'footer',
                        itemId: 'footer',
                        items: [
                            {
                                xtype: 'rallybutton',
                                text: 'Save & Calculate',
                                handler: function() {
                                    this._save();
                                },
                                scope: this
                            },
                            {
                                xtype: 'rallybutton',
                                text: 'Cancel',
                                ui: 'link',
                                handler: function() {
                                    this.hide();
                                },
                                scope: this
                            }
                        ]
                    });
            	},
            	setFormula: function(formula) {
            		this.formula = formula;
            		this.down('#formula_box').setValue(this.formula); 
            	},
            	_save: function() {
            		if (this.fireEvent('beforeformulasave', this.formula) !== false) {
            			console.log("About to save", this.formula);
            			this.hide();
            		}
            	}
            });            /*global console, Ext */
            Ext.define('CustomApp', {
                extend: 'Rally.app.App',
                componentCls: 'app',
                items: [ 
                    { xtype: 'container', itemId: 'picker_row', defaults: { padding: 5},  layout: { type: 'hbox' }, items: [
            	        { xtype: 'container', itemId: 'type_picker_box' },
            	        { xtype: 'container', itemId: 'column_picker_box' },
                        { xtype: 'container', itemId: 'calculator_box' }
                    ]},
                    { xtype: 'container', itemId: 'pi_grid_box', padding: 5 }
                ],
                /*minimum_columns: [ {text: "ID", dataIndex: "FormattedID"}, {text: "Name", dataIndex: "Name", editor: { xtype: "rallytextfield", width: 250 }, flex: 1 } ], */
                minimum_columns: [ {text: "ID", dataIndex: "FormattedID"}, {text: "Name", dataIndex: "Name", flex: 1 } ],
                additional_columns: [],
                calculation_fields: [],
                type: null,
                launch: function() {
                    this._addCalculator();
                    this._addFieldPicker();
                    this._addTypePicker();
                },
                _addCalculator: function() {
                    var calculator_dialog = Ext.create('PXS.ui.dialog.FormulaDialog', {
                        width: 400,
                        title: 'Calculator'
                    });
            
                    var calculator = Ext.create('Rally.ui.Button', {
                        text: 'Define Calculator',
                        listeners: {
                            click: function( button, event, options ) {
                                calculator_dialog.setFormula("Fred");
                                calculator_dialog.show();
                            }
                        }
                    });
                    this.down('#calculator_box').add(calculator);
                },
                _addFieldPicker: function() {
                    var that = this;
                    var picker = Ext.create('Rally.ui.picker.FieldPicker', {
                        modelType: "PortfolioItem",
                        fieldLabel: "Columns",
                        labelSeparator: "",
                        labelWidth: 45,
                        labelPad: 5,
                        labelCls: "rui-label",
                        stateEvents: ['selectionchange' ],
                        stateful: true,
                        stateId: 'pi-score-columns',
                        fieldWhiteList: ["ActualStartDate", "ActualEndDate", "PlannedStartDate", "PlannedEndDate", "PercentDoneByStoryCount", "PercentDoneByStoryPlanEstimate", "InvestmentCategory","RiskScore", "ValueScore"],
                        listeners: {
                            change: function(picker, newValue, oldValue ) {
                                console.log( "change", picker.getValue, newValue );
                            },
                            selectionchange: function( picker, values, options ) {
                                console.log( "selectionchange", picker.getValue(), values );
                                that._setAdditionalColumns(values);
                                that._getPortfolioItems();
                            }
                        },
                        getState: function() {
                            return { value: this.getValue() };
                        },
                        applyState: function(state) {
                            that._setAdditionalColumns(state.value);
                            this.setValue(state.value);
                        }
                    });  
                    this.down('#column_picker_box').add(picker);
                },
                _setAdditionalColumns: function( values ) {
                    var that = this;
                    that.additional_columns = [];
                    Ext.Array.each( values, function(value) {
                        that.additional_columns.push( {text: value.displayName, dataIndex: value.name});
                    });
                    return true;
                },
                _addTypePicker: function() {
                    var picker = Ext.create('Rally.ui.combobox.PortfolioItemTypeComboBox', {
                        listeners: { 
                           scope: this, 
                           change: function(picker,newValue,oldValue) {
                                this.type = picker.getRecord().getData().TypePath;
                                this._getPortfolioItems();
                           }
                        } 
                    });
                    this.down('#type_picker_box').add(picker);
                },
                _getPortfolioItems: function() {
                	console.log( "_getPortfolioItems" );
                    var that = this;
                	this.pi_store = Ext.create('Rally.data.WsapiDataStore', {
                		autoLoad: true,
                		model: that.type,
                		listeners: {
                			load: function(store,data,success) {
                				this._showGrid();
                			},
                			scope: this
                		},
                		fetch: that._getFetchFields()
                	});
                },
                _getFetchFields: function() {
                    var fields = [];
                    var cols = Ext.Array.merge( this.minimum_columns, this.additional_columns );
                    Ext.Array.each( cols, function( col ) {
                        fields.push( col.name );
                    });
                },
                _showGrid: function() {
                	console.log( "_showGrid");
                	var that = this;
                	if ( this.pi_grid ) { this.pi_grid.destroy(); }
                	this.pi_grid = Ext.create('Rally.ui.grid.Grid', {
                		store: that.pi_store,
                        model: 'PortfolioItem/Feature',
                        enableEditing: true,
                        plugins: Ext.create( 'Rally.ui.grid.plugin.CellEditing', {}),
                            
                		columnCfgs:  Ext.Array.merge( that.minimum_columns, that.additional_columns )
                	});
                	this.down('#pi_grid_box').add(this.pi_grid);
            //        var records = this.pi_store.getRecords();
            //        Ext.Array.each( records, function(record) { 
            //            record.set("RiskScore", 6);
            //            record.save();
            //        });
                  
                }
            });

            Rally.launchApp('CustomApp', {
                name: 'PI Scoring App'
            });
        });
    </script>

    <style type="text/css">
        .app {
             /* Add app styles here */
        }
    </style>
</head>
<body></body>
</html>
